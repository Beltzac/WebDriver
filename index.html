<!DOCTYPE html>
<html>
<head>
    <title>WebDriver GUI Navigator</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #controls { margin-bottom: 20px; }
        #sessionInfo { margin: 20px 0; padding: 10px; background: #f0f0f0; }
        #elementTree { border: 1px solid #ddd; padding: 10px; height: 400px; overflow: auto; }
        button { padding: 8px 12px; margin-right: 10px; }
        .element { margin-left: 20px; cursor: pointer; }
        .element:hover { background: #f0f0f0; }
    </style>
</head>
<body>
    <h1>WebDriver GUI Navigator</h1>

    <div id="controls">
        <button id="startSession">Start Session</button>
        <button id="refreshElements">Refresh Elements</button>
    </div>

    <div id="sessionInfo">Session not started</div>

    <div id="elementTree">No elements loaded</div>

    <script>
        let sessionId = null;

        async function makeRequest(url, method, body = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            };
            if (body) options.body = JSON.stringify(body);

            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('Request failed:', error);
                throw error;
            }
        }

        document.getElementById('startSession').addEventListener('click', async () => {
            try {
                const capabilities = {
                    capabilities: {
                        alwaysMatch: {
                            platformName: "windows",
                            "appium:automationName": "flaui",
                            "appium:app": "C:\\Users\\Beltzac\\Downloads\\CTOSTEST\\CTOS1TEST\\DIS\\CM.CTOS.WinUIAdmin.exe"
                        },
                        firstMatch: [{}]
                    }
                };

                const data = await makeRequest('http://localhost:5000/session', 'POST', capabilities);
                sessionId = data.value.sessionId;
                document.getElementById('sessionInfo').innerHTML =
                    `Session ID: ${sessionId}<br>Capabilities: ${JSON.stringify(data.value.capabilities)}`;

            } catch (error) {
                document.getElementById('sessionInfo').innerHTML =
                    `Error: ${error.message}`;
            }
        });

        async function getElementDetails(elementId) {
            if (!sessionId) return null;

            try {
                const [nameRes, rectRes, enabledRes, tagNameRes] = await Promise.all([
                    makeRequest(
                        `http://localhost:5000/session/${sessionId}/element/${elementId}/attribute/Name`,
                        'GET'
                    ),
                    makeRequest(
                        `http://localhost:5000/session/${sessionId}/element/${elementId}/rect`,
                        'GET'
                    ),
                    makeRequest(
                        `http://localhost:5000/session/${sessionId}/element/${elementId}/enabled`,
                        'GET'
                    ),
                    makeRequest(
                        `http://localhost:5000/session/${sessionId}/element/${elementId}/name`,
                        'GET'
                    )
                ]);

                return {
                    id: elementId,
                    name: nameRes.value,
                    type: tagNameRes.value,
                    x: rectRes.value.x,
                    y: rectRes.value.y,
                    width: rectRes.value.width,
                    height: rectRes.value.height,
                    enabled: enabledRes.value
                };
            } catch (error) {
                console.error('Error getting element details:', error);
                return null;
            }
        }

        async function getElements() {
            if (!sessionId) return [];

            try {
                const data = await makeRequest(
                    `http://localhost:5000/session/${sessionId}/elements`,
                    'POST',
                    { using: 'xpath', value: '//*' }
                );
                return data.value;
            } catch (error) {
                console.error('Error getting elements:', error);
                return [];
            }
        }

        async function buildElementTree() {
            try {
                const elements = await getElements();
                let htmlContent = '<div class="tree">';

                for (const element of elements) {
                    const elementId = Object.values(element)[0];
                    const details = await getElementDetails(elementId);
                    if (!details) continue;

                    try {
                        const screenshotRes = await makeRequest(
                            `http://localhost:5000/session/${sessionId}/element/${elementId}/screenshot`,
                            'GET'
                        );
                        htmlContent += `
                        <div class="element" data-id="${elementId}">
                            <div style="display: flex; gap: 20px; align-items: center;">
                                <div>
                                    <strong>${details.name || 'Unnamed'}</strong> (${details.type})<br>
                                    ID: ${elementId}<br>
                                    Position: (${details.x}, ${details.y})<br>
                                    Size: ${details.width}x${details.height}<br>
                                    Enabled: ${details.enabled}<br>
                                    <button class="action-btn" data-action="click" data-id="${elementId}">Click</button>
                                    <button class="action-btn" data-action="setValue" data-id="${elementId}">Set Value</button>
                                </div>
                                <img src="data:image/png;base64,${screenshotRes.value}" style="max-width: 200px; border: 1px solid #ddd;">
                            </div>
                        </div>`;
                    } catch (error) {
                        console.error('Error getting screenshot:', error);
                        htmlContent += `
                        <div class="element" data-id="${elementId}">
                            <strong>${details.name || 'Unnamed'}</strong> (${details.type})<br>
                            ID: ${elementId}<br>
                            Position: (${details.x}, ${details.y})<br>
                            Size: ${details.width}x${details.height}<br>
                            Enabled: ${details.enabled}<br>
                            <button class="action-btn" data-action="click" data-id="${elementId}">Click</button>
                            <button class="action-btn" data-action="setValue" data-id="${elementId}">Set Value</button>
                        </div>`;
                    }
                }

                htmlContent += '</div>';
                document.getElementById('elementTree').innerHTML = htmlContent;

                // Event delegation for click actions
                document.getElementById('elementTree').addEventListener('click', async (e) => {
                    const btn = e.target.closest('.action-btn');
                    if (!btn) return;

                    e.stopPropagation();
                    const elementId = btn.getAttribute('data-id').trim();
                    const action = btn.getAttribute('data-action');

                    try {
                        if (action === 'click') {
                            await makeRequest(
                                `http://localhost:5000/session/${sessionId}/element/${elementId}/click`,
                                'POST'
                            );
                            btn.style.backgroundColor = '#d4edda';
                        } else if (action === 'setValue') {
                            const value = prompt('Enter value to set:');
                            if (value !== null) {

                                await makeRequest(
                                    `http://localhost:5000/session/${sessionId}/element/${elementId}/value`,
                                    'POST',
                                    { value: [value] }
                                );
                            }
                        }
                    } catch (error) {
                        console.error('Error performing action:', error);
                    }
                });
            } catch (error) {
                console.error('Error building element tree:', error);
                document.getElementById('elementTree').innerHTML = 'Error loading elements';
            }
        }

        document.getElementById('refreshElements').addEventListener('click', buildElementTree);
    </script>
</body>
</html>